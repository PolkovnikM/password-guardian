name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  backend-ci:
    name: Backend CI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install backend dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8

      - name: Backend lint (flake8)
        working-directory: backend
        run: |
          echo "ğŸ” Lint backend code"
          flake8 app/ --select=E9,F63,F7,F82 --show-source --statistics
          flake8 app/ --exit-zero --max-line-length=127 --statistics

      - name: Backend basic tests
        working-directory: backend
        run: |
          echo "ğŸ§ª Run backend basic tests"

          python -c "
          from app.generator import PasswordGenerator
          from app.validator import PasswordValidator

          # Test PasswordGenerator
          generator = PasswordGenerator()
          generated_password = generator.generate(12)

          # Check that password is generated and has correct length
          assert isinstance(generated_password, str), 'Generated password should be a string'
          assert len(generated_password) == 12, f'Password should be 12 chars long, got {len(generated_password)}'
          print(f'âœ… Password generated: {generated_password}')

          # Test PasswordValidator
          validator = PasswordValidator()
          validation_result = validator.validate('Test123!')

          # Check that validation returns a dictionary with expected structure
          assert isinstance(validation_result, dict), 'Validation result should be a dictionary'
          assert 'strength' in validation_result, 'Validation result should contain strength key'
          print(f'âœ… Validation result: {validation_result}')

          print('âœ… Backend basic tests passed')
          "
      - name: Backend build check
        working-directory: backend
        run: |
          echo "ğŸš€ Check backend startup"
          uvicorn app.main:app --host 127.0.0.1 --port 8000 &
          PID=$!
          sleep 3
          kill $PID || true
          echo "âœ… Backend starts successfully"

  frontend-ci:
    name: Frontend CI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Frontend structure check
        run: |
          echo "ğŸŒ Check frontend files"

          if [ ! -f frontend/index.html ]; then
            echo "âŒ frontend/index.html not found"
            exit 1
          fi

          echo "âœ… frontend/index.html exists"

          if grep -q "<!DOCTYPE html>" frontend/index.html; then
            echo "âœ… HTML doctype found"
          else
            echo "âš ï¸ HTML doctype not found"
          fi

          if grep -q "<title>" frontend/index.html; then
            echo "âœ… HTML title found"
          else
            echo "âš ï¸ HTML title not found"
          fi

          echo "âœ… Frontend check finished"
