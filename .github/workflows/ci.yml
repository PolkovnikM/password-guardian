name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  check-structure:
    name: Check project structure
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check required files
      run: |
        echo " –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞..."

        required_backend=(
          "backend/requirements.txt"
          "backend/app/__init__.py"
          "backend/app/main.py"
          "backend/app/generator.py"
          "backend/app/validator.py"
        )

        for file in "${required_backend[@]}"; do
          if [ -f "$file" ]; then
            echo " $file –Ω–∞–π–¥–µ–Ω"
          else
            echo " $file –Ω–µ –Ω–∞–π–¥–µ–Ω"
            exit 1
          fi
        done

        required_frontend=(
          "frontend/index.html"
        )

        for file in "${required_frontend[@]}"; do
          if [ -f "$file" ]; then
            echo " $file –Ω–∞–π–¥–µ–Ω"
          else
            echo " $file –Ω–µ –Ω–∞–π–¥–µ–Ω"
            exit 1
          fi
        done

        echo " –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"

  backend-lint:
    name: Backend lint and test
    runs-on: ubuntu-latest
    needs: check-structure

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      working-directory: backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 pytest

    - name: Lint with flake8
      working-directory: backend
      run: |
        echo " –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è –∫–æ–¥–∞ Python..."
        flake8 app/ --select=E9,F63,F7,F82 --show-source --statistics
        flake8 app/ --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    - name: Simple Python tests
      working-directory: backend
      run: |
        echo "üß™ –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Å—Ç—ã—Ö —Ç–µ—Å—Ç–æ–≤..."

python - << 'EOF'
from app.generator import PasswordGenerator
from app.validator import PasswordValidator

print(" –ú–æ–¥—É–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")

g = PasswordGenerator()
result = g.generate(12)
assert "password" in result

v = PasswordValidator()
result = v.validate("Test123!")
assert "strength" in result
EOF


        echo " –í—Å–µ –±–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã"

  backend-build:
    name: Backend build check
    runs-on: ubuntu-latest
    needs: backend-lint

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      working-directory: backend
      run: pip install -r requirements.txt

    - name: Check server startup
      working-directory: backend
      run: |
        echo " –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞..."

        uvicorn app.main:app --host 0.0.0.0 --port 8000 &
        SERVER_PID=$!

        sleep 3

        if curl -f http://localhost:8000/health; then
          echo "–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –∏ –æ—Ç–≤–µ—á–∞–µ—Ç"
        else
          echo "–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
          exit 1
        fi

        kill $SERVER_PID 2>/dev/null || true

  frontend-check:
    name: Frontend validation
    runs-on: ubuntu-latest
    needs: check-structure

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check HTML validity
      run: |
        echo " –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."

        if [ -f "frontend/index.html" ]; then
          echo " index.html –Ω–∞–π–¥–µ–Ω"
        else
          echo " index.html –Ω–µ –Ω–∞–π–¥–µ–Ω"
          exit 1
        fi

        echo " –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø—Ä–æ–≤–µ—Ä–µ–Ω"

  success:
    name: Final success
    runs-on: ubuntu-latest
    needs: [backend-build, frontend-check]

    steps:
    - name: Project summary
      run: |
        echo " –í–°–ï –ü–†–û–í–ï–†–ö–ò –ü–†–û–ô–î–ï–ù–´!"
        echo "Password Guardian —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–µ–ª CI pipeline"
