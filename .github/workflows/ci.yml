name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  backend-ci:
    name: Backend CI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install backend dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8

      - name: Backend lint (flake8)
        working-directory: backend
        run: |
          echo "üîç Lint backend code"
          flake8 app/ --select=E9,F63,F7,F82 --show-source --statistics
          flake8 app/ --exit-zero --max-line-length=127 --statistics

      - name: Backend basic tests
        working-directory: backend
        run: |
          echo "üß™ Run backend basic tests"

          python -c "
          from app.generator import PasswordGenerator
          from app.validator import PasswordValidator

          # Test PasswordGenerator
          generator = PasswordGenerator()
          result = generator.generate(12)
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
          if isinstance(result, dict):
              # –ï—Å–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å–ª–æ–≤–∞—Ä—å
              assert 'password' in result, 'Generated dictionary should contain password key'
              password = result['password']
              print(f'‚úÖ Password from dict: {password}')
          elif isinstance(result, str):
              # –ï—Å–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–∞
              password = result
              print(f'‚úÖ Password as string: {password}')
          else:
              raise AssertionError(f'Unexpected return type: {type(result)}')
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –ø–∞—Ä–æ–ª—è
          assert len(password) == 12, f'Password should be 12 chars long, got {len(password)}'
          assert isinstance(password, str), 'Password should be a string'

          # Test PasswordValidator
          validator = PasswordValidator()
          validation_result = validator.validate('Test123!')
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é
          assert isinstance(validation_result, dict), 'Validation result should be a dictionary'
          assert 'strength' in validation_result, 'Validation result should contain strength key'
          assert validation_result['strength'] in ['weak', 'medium', 'strong'], f'Invalid strength value: {validation_result[\"strength\"]}'
          
          print(f'‚úÖ Validation result: {validation_result}')
          print('‚úÖ Backend basic tests passed')
          "

  frontend-ci:
    name: Frontend CI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Frontend structure check
        run: |
          echo "üåê Check frontend files"

          if [ ! -f frontend/index.html ]; then
            echo "‚ùå frontend/index.html not found"
            exit 1
          fi

          echo "‚úÖ frontend/index.html exists"

          if grep -q "<!DOCTYPE html>" frontend/index.html; then
            echo "‚úÖ HTML doctype found"
          else
            echo "‚ö†Ô∏è HTML doctype not found"
          fi

          if grep -q "<title>" frontend/index.html; then
            echo "‚úÖ HTML title found"
          else
            echo "‚ö†Ô∏è HTML title not found"
          fi

          echo "‚úÖ Frontend check finished"
