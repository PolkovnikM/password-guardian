name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  check-structure:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Display structure
      run: |
        echo "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:"
        find . -type f -name "*.py" -o -name "*.html" -o -name "*.css" -o -name "*.js" | sort
        echo ""
        echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    
    - name: Check required files
      run: |
        required_files=(
          "backend/app/main.py"
          "backend/app/generator.py"
          "backend/app/validator.py"
          "frontend/index.html"
          "README.md"
        )
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "‚úÖ $file –Ω–∞–π–¥–µ–Ω"
          else
            echo "‚ùå $file –Ω–µ –Ω–∞–π–¥–µ–Ω"
            exit 1
          fi
        done

  python-lint:
    runs-on: ubuntu-latest
    needs: check-structure
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install linter
      run: pip install flake8
    
    - name: Lint Python files
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è –∫–æ–¥–∞ Python..."
        cd backend
        flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 app/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        echo "–õ–∏–Ω—Ç–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω"

  python-test:
    runs-on: ubuntu-latest
    needs: python-lint
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        pip install pytest
    
    - name: Run simple tests
      run: |
        echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
        cd backend
        
        # –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π
        python -c "
from app.generator import PasswordGenerator
from app.validator import PasswordValidator
print('–ú–æ–¥—É–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ')
        "
        
        # –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∞—Ä–æ–ª—è
        python -c "
from app.generator import PasswordGenerator
g = PasswordGenerator()
result = g.generate(12)
assert 'password' in result
assert len(result['password']) == 12
print(f'–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç: {result[\"password\"]}')
        "
        
        # –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        python -c "
from app.validator import PasswordValidator
v = PasswordValidator()
result = v.validate('Test123!')
assert 'strength' in result
assert 'score' in result
print(f'–í–∞–ª–∏–¥–∞—Ç–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç. –û—Ü–µ–Ω–∫–∞: {result[\"score\"]}')
        "
        
        echo "–í—Å–µ –±–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã"

  build-check:
    runs-on: ubuntu-latest
    needs: python-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt
    
    - name: Check if server starts
      run: |
        echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞..."
        cd backend
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –≤ —Ñ–æ–Ω–µ
        uvicorn app.main:app --host 0.0.0.0 --port 8000 &
        SERVER_PID=$!
        
        # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫
        sleep 3
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ
        if curl -f http://localhost:8000/health; then
          echo "–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –∏ –æ—Ç–≤–µ—á–∞–µ—Ç"
        else
          echo "–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
          exit 1
        fi
        
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä
        kill $SERVER_PID 2>/dev/null || true
        sleep 1

  success:
    runs-on: ubuntu-latest
    needs: [check-structure, python-lint, python-test, build-check]
    
    steps:
    - name: Final report
      run: |
        echo "üéâ –í–°–ï –ü–†–û–í–ï–†–ö–ò –ü–†–û–ô–î–ï–ù–´!"
        echo ""
        echo "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞:"
        echo "- Python —Ñ–∞–π–ª–æ–≤: $(find . -name "*.py" | wc -l)"
        echo "- HTML/CSS/JS —Ñ–∞–π–ª–æ–≤: $(find . -name "*.html" -o -name "*.css" -o -name "*.js" | wc -l)"
        echo "- –í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: $(find . -type f | wc -l)"
        echo ""
        echo "–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ"
        echo "API: http://localhost:8000"
        echo "Frontend: frontend/index.html"
